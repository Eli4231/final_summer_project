<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>×¤×¨×•×™×§×˜</title>
  <link rel="stylesheet" href="project.css">
</head>
<body>
  <a href="index.html">â¬… ×—×–×¨×”</a>
  <div id="project"></div>

  <script>
    function getParam(name) {
      return new URLSearchParams(window.location.search).get(name);
    }

    const id = parseInt(getParam("id"));

    async function loadProject() {
      try {
        let response = await fetch(`/p/${id}`);
        if (!response.ok) {
          document.getElementById("project").innerHTML = "<p>×”×¤×¨×•×™×§×˜ ×œ× × ××¦×</p>";
          return;
        }
        let project = await response.json();
        renderProject(project);
      } catch (err) {
        document.getElementById("project").innerHTML = "<p>×©×’×™××” ×‘×˜×¢×™× ×ª ×”×¤×¨×•×™×§×˜</p>";
      }
    }

    function renderProject(project) {
      let voted = JSON.parse(localStorage.getItem("votedProjects")) || [];
      let disabled = voted.includes(project.id) ? "disabled" : "";

      document.getElementById("project").innerHTML = `
        <div class="project-page">
          <h1>${project.name}</h1>
          <img src="/images/${project.myFileName}?t=${Date.now()}" alt="${project.name}">
          <p>${project.description}</p>
          <p><strong>×§×•×œ×•×ª:</strong> <span id="vote-count">${project.votes}</span></p>
          <button id="vote-btn" onclick="vote(${project.id})" ${disabled}>ğŸ‘ ×”×¦×‘×¢</button>
        </div>
      `;
    }

    function vote(id) {
      let userId = localStorage.getItem("userId") || Date.now().toString();
      localStorage.setItem("userId", userId);

      fetch(`/p/${id}/vote`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ userId }),
      })
        .then((res) => res.json())
        .then((data) => {
          alert(data.message);
          if (data.votes !== undefined) {
            document.getElementById("vote-count").textContent = data.votes;
          }

          let voted = JSON.parse(localStorage.getItem("votedProjects")) || [];
          if (!voted.includes(id)) {
            voted.push(id);
            localStorage.setItem("votedProjects", JSON.stringify(voted));
          }

          let btn = document.getElementById("vote-btn");
          if (btn) btn.setAttribute("disabled", true);
        });
    }

    loadProject();
  </script>
</body>
</html>